// Code generated by hertz generator.

package search

import (
	"context"
	"fmt"
	"strings"

	"files/pkg/common"
	"files/pkg/files"
	"files/pkg/global"
	"files/pkg/hertz/biz/dal/database"
	"files/pkg/hertz/biz/handler"
	search "files/pkg/hertz/biz/model/api/search"
	"files/pkg/models"

	"github.com/cloudwego/hertz/pkg/app"
	"k8s.io/klog/v2"
)

// GetDirectories .
// @router /api/search/get_directory/ [POST]
func GetDirectories(ctx context.Context, c *app.RequestContext) {
	owner := string(c.GetHeader(common.REQUEST_HEADER_OWNER))
	if owner == "" {
		handler.RespError(c, common.ErrorMessageOwnerNotFound)
		return
	}

	klog.Infof("[search] GetDirectories, owner: %s", owner)

	nodes := global.GlobalNode.GetNodes()

	internalShares, externalShares, err := database.QuerySearchSharedDirectories(owner)
	if err != nil {
		klog.Errorf("[search] GetDirectories, owner: %s, query shares error: %v", owner, err)
		handler.RespError(c, fmt.Sprintf("Query Shares Error: %v", err))
		return
	}

	var result []*search.DirectoryInfo
	for _, s := range internalShares {
		if s.Owner != owner {
			var di = &search.DirectoryInfo{
				Path:       fmt.Sprintf("/%s/%s/%s/", s.FileType, s.Extend, strings.Trim(s.Path, "/")),
				SharePath:  fmt.Sprintf("/share/%s/", s.ID),
				Owner:      s.Owner,
				Permission: s.Permission,
			}
			result = append(result, di)
		}
	}
	for _, s := range externalShares {
		if s.Owner != owner {
			var di = &search.DirectoryInfo{
				Path:       fmt.Sprintf("/%s/%s/%s/", s.FileType, s.Extend, strings.Trim(s.Path, "/")),
				SharePath:  fmt.Sprintf("/share/%s/", s.ID),
				Owner:      s.Owner,
				Permission: s.Permission,
			}
			result = append(result, di)
		}
	}

	for _, n := range nodes {
		result = append(result, &search.DirectoryInfo{
			Path:       fmt.Sprintf("/cache/%s/", n.Name),
			Owner:      owner,
			Permission: 4,
		}, &search.DirectoryInfo{
			Path:       fmt.Sprintf("/external/%s/", n.Name),
			Owner:      owner,
			Permission: 4,
		})
	}

	result = append(result,
		&search.DirectoryInfo{
			Path:       "/drive/Home/",
			Owner:      owner,
			Permission: 4,
		},
		&search.DirectoryInfo{
			Path:       "/drive/Data/",
			Owner:      owner,
			Permission: 4,
		},
	)

	klog.Infof("[search] GetDirectories, owner: %s, result: %v", owner, common.ParseString(result))

	handler.RespSuccess(c, result)
}

// CheckDirectory .
// @router /api/search/check_directory/*path [POST]
func CheckDirectory(ctx context.Context, c *app.RequestContext) {
	var sharePath = c.Param("path")

	owner := string(c.GetHeader(common.REQUEST_HEADER_OWNER))
	if owner == "" {
		handler.RespError(c, common.ErrorMessageOwnerNotFound)
		return
	}

	fileParam, err := models.CreateFileParam(owner, sharePath)
	if err != nil {
		handler.RespError(c, common.ErrorMessagePathInvalid)
		return
	}

	fileParam.Extend = common.TrimShareId(fileParam.Extend)

	var uri string
	var realPath string
	var realOwner string
	var permission int32

	if fileParam.FileType == common.Share {
		shared, err := database.GetSharePath(fileParam.Extend)
		if err != nil {
			klog.Errorf("[search] CheckDirectory, get share failed, owner: %s, error: %v", owner, err)
			handler.RespError(c, fmt.Sprintf("Check Directory Error: %v", err))
			return
		}

		if shared == nil {
			handler.RespError(c, common.ErrorMessageShareNotExists)
			return
		}

		if shared.FileType == common.Sync {
			handler.RespError(c, common.ErrorMessageSyncNotSupport)
			return
		}

		member, err := database.GetShareMember(shared.ID, owner)
		if err != nil {
			klog.Errorf("[search] CheckDirectory, get member failed, owner: %s, error: %v", owner, err)
			handler.RespError(c, fmt.Sprintf("Check Directory Error: %v", err))
			return
		}

		if member == nil {
			permission = 0
		} else {
			permission = member.Permission
		}

		realPath = fmt.Sprintf("/%s/%s/%s/", shared.FileType, shared.Extend, strings.Trim(shared.Path, "/"))
		realOwner = shared.Owner

		realParam, err := models.CreateFileParam(realOwner, realPath)
		if err != nil {
			klog.Errorf("[search] CheckDirectory, get param failed, owner: %s, error: %v, path: %s", realOwner, err, realPath)
			handler.RespError(c, fmt.Sprintf("Check Directory Error: %v", err))
			return
		}
		uri, err = realParam.GetResourceUri()
		if err != nil {
			klog.Errorf("[search] CheckDirectory, get uri error: %v", err)
			handler.RespError(c, fmt.Sprintf("Check Directory Error: %v", err))
			return
		}

		uri = strings.TrimSuffix(uri, "/") + realParam.Path
	} else {
		uri, err = fileParam.GetResourceUri()
		if err != nil {
			klog.Errorf("[search] CheckDirectory, get uri error: %v", err)
			handler.RespError(c, fmt.Sprintf("Check Directory Error: %v", err))
			return
		}
		uri = strings.TrimSuffix(uri, "/") + fileParam.Path
	}

	klog.Infof("[search] CheckDirectory, owner: %s, uri: %s", owner, uri)

	permit, exists := files.CanWriteDir(uri)
	if !exists {
		handler.RespError(c, common.ErrorMessageDirNotExists)
		return
	}
	if permit {
		permission = 3
	} else {
		permission = 1
	}

	if !strings.HasPrefix(sharePath, "/") {
		sharePath = "/" + sharePath
	}

	var result = &search.CheckDirectoryResp{
		Path:       sharePath,
		Permission: permission,
	}

	handler.RespSuccess(c, result)
}
